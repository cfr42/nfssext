# This is a basic workflow to help you get started with Actions

# https://github.com/latex3/hyperref/blob/adc36adbc3650db73329469b43afb0ee86e3c807/.github/workflows/main.yaml
# https://github.com/josephwright/siunitx/blob/main/.github/workflows/main.yaml

name: Automatic Checks

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: 
      - "*"
  pull_request:
    branches: 
      - "*"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "l3build"
  l3build-ctan:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # https://github.com/josephwright/siunitx/blob/549cad913591b92a3a199b7477a325866303bf29/.github/workflows/main.yaml
      # We need Ghostscript for XeTeX tests.
      - run: sudo apt-get update && sudo apt-get install ghostscript
      - name: Install TeX Live
        uses: zauguin/install-texlive@v3
        with:
          # List the required TeX Live packages in a separate file to allow reuse in
          # different workflows.
          package_file: .github/tl_packages
      - name: Remove environmental restrictions
        run: sed -i '/^os\.setenv /d' $(find . -name "*.lua") 
      - name: Run l3build for support packages
        run: for i in nfssext-cfr fontscripts ; do (cd $i && l3build ctan) ; done
      - name: Archive failed test output for support packages
        # what does this do exactly?
        if: ${{ always() }}
        uses: zauguin/l3build-failure-artifacts@v1
        with:
          name: testfiles-nfssext-support
          # Decide how long to keep the test output artefact:
          # retention-days: 3
      - name: Run l3build for cfr-lm
        run: (cd cfr-lm ;  cp -r $(kpsewhich -var-value TEXMFDIST)/fonts/afm/public/lm afm && cp -r $(kpsewhich -var-value TEXMFDIST)/fonts/tfm/public/lm tfm && l3build fnttarg && l3build ctan)
      # https://github.com/latex3/hyperref/blob/adc36adbc3650db73329469b43afb0ee86e3c807/.github/workflows/main.yaml
      - name: Archive failed test output for cfr-lm
        # what does this do exactly?
        if: ${{ always() }}
        uses: zauguin/l3build-failure-artifacts@v1
        with:
          name: testfiles-nfssext-clm
          # Decide how long to keep the test output artefact:
          # retention-days: 3
      - name: Run l3build for ADF font packages
        run: for i in arkandis/adforn arkandis/adfsymb arkandis/baskervaldadf arkandis/berenisadf arkandis/electrumadf arkandis/librisadf arkandis/romandeadf arkandis/venturisadf ; do (cd $i && l3build fnttarg && l3build ctan) ; done
      # https://github.com/latex3/hyperref/blob/adc36adbc3650db73329469b43afb0ee86e3c807/.github/workflows/main.yaml
      - name: Archive failed test output for ADF
        # what does this do exactly?
        if: ${{ always() }}
        uses: zauguin/l3build-failure-artifacts@v1
        with:
          name: testfiles-nfssext-adf
          # Decide how long to keep the test output artefact:
          # retention-days: 3
